{% extends 'oauth/base.html' %}
{% load static %}

{% block title %}Réinitialisation du mot de passe - CSIG{% endblock %}

{% block content %}
<div class="auth-card">
    <div class="auth-card-header text-center">
        <h2 class="auth-title">
            <i class="fas fa-key me-2"></i>Réinitialisation du mot de passe
        </h2>
        <p class="auth-description">Entrez votre nouveau mot de passe</p>
    </div>
    
    <div class="auth-card-body">
        <form method="post" class="auth-form" data-validate>
            {% csrf_token %}
            
            <!-- Nouveau mot de passe -->
            <div class="mb-3">
                <label for="new_password1" class="form-label">
                    <i class="fas fa-lock me-2"></i>Nouveau mot de passe *
                </label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-lock"></i>
                    </span>
                    <input type="password" name="new_password1" id="new_password1" 
                           class="form-control" placeholder="Nouveau mot de passe" required>
                    <button class="btn btn-outline-secondary" type="button" id="togglePassword1">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>Votre mot de passe doit contenir au moins 8 caractères.
                </div>
                
                <!-- Indicateur de force du mot de passe -->
                <div class="password-strength mt-2" id="passwordStrength">
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">Force du mot de passe:</small>
                        <small class="strength-text"></small>
                    </div>
                    <div class="progress mt-1" style="height: 4px;">
                        <div class="password-strength-bar progress-bar" role="progressbar"></div>
                    </div>
                </div>
            </div>
            
            <!-- Confirmation du nouveau mot de passe -->
            <div class="mb-3">
                <label for="new_password2" class="form-label">
                    <i class="fas fa-lock me-2"></i>Confirmer le nouveau mot de passe *
                </label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-lock"></i>
                    </span>
                    <input type="password" name="new_password2" id="new_password2" 
                           class="form-control" placeholder="Confirmer le nouveau mot de passe" required>
                    <button class="btn btn-outline-secondary" type="button" id="togglePassword2">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>Entrez le même mot de passe que précédemment, pour vérification.
                </div>
                <div class="invalid-feedback" id="passwordMismatch" style="display: none;">
                    <i class="fas fa-exclamation-circle me-1"></i>Les mots de passe ne correspondent pas.
                </div>
            </div>
            
            <!-- Bouton de soumission -->
            <div class="mb-3">
                <button type="submit" class="btn btn-primary btn-lg w-100" id="resetPasswordBtn">
                    <i class="fas fa-key me-2"></i>Réinitialiser le mot de passe
                    <span class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                </button>
            </div>
        </form>
        
        <!-- Instructions de sécurité -->
        <div class="alert alert-info">
            <i class="fas fa-shield-alt me-2"></i>
            <strong>Conseils de sécurité :</strong>
            <ul class="mb-0 mt-2">
                <li>Utilisez un mot de passe unique pour ce compte</li>
                <li>Évitez les informations personnelles facilement devinables</li>
                <li>Combinez lettres, chiffres et symboles</li>
                <li>Changez régulièrement votre mot de passe</li>
            </ul>
        </div>
    </div>
    
    <div class="auth-card-footer text-center">
        <p class="mb-0">
            <a href="{% url 'oauth:login' %}" class="auth-link">
                <i class="fas fa-arrow-left me-1"></i>Retour à la connexion
            </a>
        </p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Toggle password visibility
    $('#togglePassword1, #togglePassword2').on('click', function() {
        const passwordField = $(this).siblings('input[type="password"], input[type="text"]');
        const icon = $(this).find('i');
        
        if (passwordField.attr('type') === 'password') {
            passwordField.attr('type', 'text');
            icon.removeClass('fa-eye').addClass('fa-eye-slash');
        } else {
            passwordField.attr('type', 'password');
            icon.removeClass('fa-eye-slash').addClass('fa-eye');
        }
    });
    
    // Validation en temps réel
    $('#new_password1, #new_password2').on('input', function() {
        validatePasswordFields();
    });
    
    // Gestion de la soumission
    $('.auth-form').on('submit', function(e) {
        if (!validatePasswordFields()) {
            e.preventDefault();
            return false;
        }
        
        const submitBtn = $(this).find('#resetPasswordBtn');
        const spinner = submitBtn.find('.spinner-border');
        const btnText = submitBtn.find('span:not(.spinner-border)');
        
        // Afficher l'état de chargement
        submitBtn.prop('disabled', true);
        spinner.removeClass('d-none');
        btnText.addClass('d-none');
    });
    
    // Auto-focus sur le premier champ
    $('#new_password1').focus();
});

// Validation des champs de mot de passe
function validatePasswordFields() {
    const password1 = $('#new_password1').val();
    const password2 = $('#new_password2').val();
    const resetBtn = $('#resetPasswordBtn');
    
    let isValid = true;
    
    // Vérifier la longueur du mot de passe
    if (password1.length < 8) {
        isValid = false;
    }
    
    // Vérifier que les mots de passe correspondent
    if (password2 && password1 !== password2) {
        $('#passwordMismatch').show();
        isValid = false;
    } else {
        $('#passwordMismatch').hide();
    }
    
    // Mettre à jour l'indicateur de force
    if (password1) {
        const strength = calculatePasswordStrength(password1);
        updatePasswordStrengthIndicator(strength);
    }
    
    // Activer/désactiver le bouton
    resetBtn.prop('disabled', !isValid);
    
    return isValid;
}

// Calculer la force du mot de passe
function calculatePasswordStrength(password) {
    let score = 0;
    
    if (password.length >= 8) score++;
    if (password.match(/[a-z]/)) score++;
    if (password.match(/[A-Z]/)) score++;
    if (password.match(/[0-9]/)) score++;
    if (password.match(/[^a-zA-Z0-9]/)) score++;
    
    if (score <= 2) return 'weak';
    if (score <= 3) return 'medium';
    return 'strong';
}

// Mettre à jour l'indicateur de force
function updatePasswordStrengthIndicator(strength) {
    const strengthBar = $('.password-strength-bar');
    const strengthText = $('.strength-text');
    
    strengthBar.removeClass('bg-danger bg-warning bg-success');
    strengthText.removeClass('text-danger text-warning text-success');
    
    switch (strength) {
        case 'weak':
            strengthBar.addClass('bg-danger').css('width', '33%');
            strengthText.addClass('text-danger').text('Faible');
            break;
        case 'medium':
            strengthBar.addClass('bg-warning').css('width', '66%');
            strengthText.addClass('text-warning').text('Moyenne');
            break;
        case 'strong':
            strengthBar.addClass('bg-success').css('width', '100%');
            strengthText.addClass('text-success').text('Forte');
            break;
    }
}

// Validation des champs
function validateField(field) {
    const value = field.value.trim();
    let isValid = true;
    let errorMessage = '';
    
    if (field.hasAttribute('required') && !value) {
        isValid = false;
        errorMessage = 'Ce champ est requis';
    }
    
    if (isValid && value) {
        if (field.id === 'new_password1' && value.length < 8) {
            isValid = false;
            errorMessage = 'Le mot de passe doit contenir au moins 8 caractères';
        }
    }
    
    if (isValid) {
        markFieldAsValid(field);
    } else {
        markFieldAsInvalid(field, errorMessage);
    }
    
    return isValid;
}

// Marquer un champ comme valide
function markFieldAsValid(field) {
    field.classList.remove('is-invalid');
    field.classList.add('is-valid');
    
    // Supprimer les messages d'erreur
    const errorDiv = field.parentNode.querySelector('.invalid-feedback');
    if (errorDiv) {
        errorDiv.remove();
    }
}

// Marquer un champ comme invalide
function markFieldAsInvalid(field, message) {
    field.classList.remove('is-valid');
    field.classList.add('is-invalid');
    
    // Supprimer l'ancien message d'erreur
    const existingError = field.parentNode.querySelector('.invalid-feedback');
    if (existingError) {
        existingError.remove();
    }
    
    // Ajouter le nouveau message d'erreur
    const errorDiv = document.createElement('div');
    errorDiv.className = 'invalid-feedback';
    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle me-1"></i>${message}`;
    
    // Insérer après le groupe d'input
    const inputGroup = field.closest('.input-group') || field.parentNode;
    inputGroup.parentNode.insertBefore(errorDiv, inputGroup.nextSibling);
}

// Effacer la validation d'un champ
function clearFieldValidation(field) {
    field.classList.remove('is-valid', 'is-invalid');
    
    // Supprimer les messages de validation
    const errorDiv = field.parentNode.querySelector('.invalid-feedback');
    if (errorDiv) {
        errorDiv.remove();
    }
    
    const validDiv = field.parentNode.querySelector('.valid-feedback');
    if (validDiv) {
        validDiv.remove();
    }
}
</script>
{% endblock %}

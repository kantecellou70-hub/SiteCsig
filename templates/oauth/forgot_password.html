{% extends 'oauth/base.html' %}
{% load static %}

{% block title %}Mot de passe oublié - CSIG{% endblock %}

{% block content %}
<div class="auth-card">
    <div class="auth-card-header text-center">
        <h2 class="auth-title">
            <i class="fas fa-key me-2"></i>Mot de passe oublié
        </h2>
        <p class="auth-description">Entrez votre adresse email pour recevoir un lien de réinitialisation</p>
    </div>
    
    <div class="auth-card-body">
        <form method="post" class="auth-form" data-validate>
            {% csrf_token %}
            
            <!-- Email -->
            <div class="form-group mb-3">
                <label for="email" class="form-label">
                    <i class="fas fa-envelope me-2"></i>Adresse email
                </label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-envelope"></i>
                    </span>
                    <input type="email" name="email" id="email" class="form-control" 
                           placeholder="votre.email@exemple.com" required>
                </div>
                <small class="form-text text-muted">
                    <i class="fas fa-info-circle me-1"></i>Nous vous enverrons un lien sécurisé pour réinitialiser votre mot de passe.
                </small>
            </div>
            
            <!-- Bouton de soumission -->
            <div class="form-group mb-3">
                <button type="submit" class="btn btn-primary btn-lg w-100 auth-submit-btn">
                    <i class="fas fa-paper-plane me-2"></i>Envoyer le lien
                    <span class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                </button>
            </div>
        </form>
        
        <!-- Instructions supplémentaires -->
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Instructions :</strong>
            <ul class="mb-0 mt-2">
                <li>Vérifiez votre dossier spam si vous ne recevez pas l'email</li>
                <li>Le lien expire après 24 heures</li>
                <li>Vous pouvez demander un nouveau lien si nécessaire</li>
            </ul>
        </div>
    </div>
    
    <div class="auth-card-footer text-center">
        <p class="mb-0">
            <a href="{% url 'oauth:login' %}" class="auth-link">
                <i class="fas fa-arrow-left me-1"></i>Retour à la connexion
            </a>
        </p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Auto-focus sur le champ email
    $('#email').focus();
    
    // Validation en temps réel
    $('#email').on('blur', function() {
        validateEmailField(this);
    });
    
    $('#email').on('input', function() {
        clearFieldValidation(this);
    });
    
    // Gestion de la soumission
    $('.auth-form').on('submit', function(e) {
        const submitBtn = $(this).find('.auth-submit-btn');
        const spinner = submitBtn.find('.spinner-border');
        const btnText = submitBtn.find('span:not(.spinner-border)');
        
        // Afficher l'état de chargement
        submitBtn.prop('disabled', true);
        spinner.removeClass('d-none');
        btnText.addClass('d-none');
        
        // Re-enable après 5 secondes
        setTimeout(function() {
            submitBtn.prop('disabled', false);
            spinner.addClass('d-none');
            btnText.removeClass('d-none');
        }, 5000);
    });
});

// Validation du champ email
function validateEmailField(field) {
    const value = field.value.trim();
    let isValid = true;
    let errorMessage = '';
    
    if (!value) {
        isValid = false;
        errorMessage = 'L\'adresse email est requise';
    } else if (!isValidEmail(value)) {
        isValid = false;
        errorMessage = 'Format d\'email invalide';
    }
    
    if (isValid) {
        markFieldAsValid(field);
    } else {
        markFieldAsValid(field, errorMessage);
    }
    
    return isValid;
}

// Marquer un champ comme valide
function markFieldAsValid(field) {
    field.classList.remove('is-invalid');
    field.classList.add('is-valid');
    
    // Supprimer les messages d'erreur
    const errorDiv = field.parentNode.querySelector('.invalid-feedback');
    if (errorDiv) {
        errorDiv.remove();
    }
}

// Marquer un champ comme invalide
function markFieldAsInvalid(field, message) {
    field.classList.remove('is-valid');
    field.classList.add('is-invalid');
    
    // Supprimer l'ancien message d'erreur
    const existingError = field.parentNode.querySelector('.invalid-feedback');
    if (existingError) {
        existingError.remove();
    }
    
    // Ajouter le nouveau message d'erreur
    const errorDiv = document.createElement('div');
    errorDiv.className = 'invalid-feedback';
    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle me-1"></i>${message}`;
    
    // Insérer après le groupe d'input
    const inputGroup = field.closest('.input-group') || field.parentNode;
    inputGroup.parentNode.insertBefore(errorDiv, inputGroup.nextSibling);
}

// Effacer la validation d'un champ
function clearFieldValidation(field) {
    field.classList.remove('is-valid', 'is-invalid');
    
    // Supprimer les messages de validation
    const errorDiv = field.parentNode.querySelector('.invalid-feedback');
    if (errorDiv) {
        errorDiv.remove();
    }
    
    const validDiv = field.parentNode.querySelector('.valid-feedback');
    if (validDiv) {
        validDiv.remove();
    }
}

// Validation email
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}
</script>
{% endblock %}

{% extends 'oauth/base.html' %}
{% load static %}

{% block title %}Contacter le support - CSIG{% endblock %}

{% block content %}
<div class="auth-card">
    <div class="auth-card-header text-center">
        <h2 class="auth-title">
            <i class="fas fa-headset me-2"></i>Contacter le support
        </h2>
        <p class="auth-description">Notre équipe est là pour vous aider</p>
    </div>
    
    <div class="auth-card-body">
        <form method="post" class="auth-form" data-validate>
            {% csrf_token %}
            
            <div class="row">
                <!-- Nom -->
                <div class="col-md-6 mb-3">
                    <label for="name" class="form-label">
                        <i class="fas fa-user me-2"></i>Nom complet *
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-user"></i>
                        </span>
                        <input type="text" name="name" id="name" class="form-control" 
                               placeholder="Votre nom complet" required>
                    </div>
                </div>
                
                <!-- Email -->
                <div class="col-md-6 mb-3">
                    <label for="email" class="form-label">
                        <i class="fas fa-envelope me-2"></i>Adresse email *
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-envelope"></i>
                        </span>
                        <input type="email" name="email" id="email" class="form-control" 
                               placeholder="votre.email@exemple.com" required>
                    </div>
                </div>
            </div>
            
            <!-- Sujet -->
            <div class="mb-3">
                <label for="subject" class="form-label">
                    <i class="fas fa-tag me-2"></i>Sujet *
                </label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-tag"></i>
                    </span>
                    <select name="subject" id="subject" class="form-select" required>
                        <option value="">Sélectionner un sujet</option>
                        <option value="technical">Problème technique</option>
                        <option value="account">Problème de compte</option>
                        <option value="billing">Facturation</option>
                        <option value="feature">Demande de fonctionnalité</option>
                        <option value="bug">Signalement de bug</option>
                        <option value="other">Autre</option>
                    </select>
                </div>
            </div>
            
            <!-- Message -->
            <div class="mb-3">
                <label for="message" class="form-label">
                    <i class="fas fa-comment me-2"></i>Message *
                </label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-comment"></i>
                    </span>
                    <textarea name="message" id="message" class="form-control" rows="6" 
                              placeholder="Décrivez votre problème ou votre demande en détail..." required></textarea>
                </div>
                <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>Plus vous détaillez votre problème, plus nous pourrons vous aider rapidement.
                </div>
            </div>
            
            <!-- Priorité -->
            <div class="mb-3">
                <label for="priority" class="form-label">
                    <i class="fas fa-exclamation-triangle me-2"></i>Niveau de priorité
                </label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-exclamation-triangle"></i>
                    </span>
                    <select name="priority" id="priority" class="form-select">
                        <option value="low">Faible - Question générale</option>
                        <option value="medium" selected>Moyenne - Problème non bloquant</option>
                        <option value="high">Élevée - Problème bloquant</option>
                        <option value="urgent">Urgente - Problème critique</option>
                    </select>
                </div>
            </div>
            
            <!-- Informations supplémentaires -->
            <div class="mb-3">
                <label for="additional_info" class="form-label">
                    <i class="fas fa-info-circle me-2"></i>Informations supplémentaires
                </label>
                <textarea name="additional_info" id="additional_info" class="form-control" rows="3" 
                          placeholder="Navigateur, système d'exploitation, étapes pour reproduire le problème..."></textarea>
                <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>Ces informations nous aident à diagnostiquer les problèmes techniques.
                </div>
            </div>
            
            <!-- Bouton de soumission -->
            <div class="mb-3">
                <button type="submit" class="btn btn-primary btn-lg w-100">
                    <i class="fas fa-paper-plane me-2"></i>Envoyer le message
                    <span class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                </button>
            </div>
        </form>
        
        <!-- Informations de contact alternatives -->
        <hr class="my-4">
        
        <div class="contact-alternatives">
            <h5 class="mb-3">
                <i class="fas fa-phone me-2"></i>Autres moyens de nous contacter
            </h5>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="contact-method p-3 bg-light rounded h-100">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-phone fa-2x text-primary me-3"></i>
                            <div>
                                <h6 class="mb-1">Téléphone</h6>
                                <p class="mb-0 text-muted">Support technique</p>
                            </div>
                        </div>
                        <p class="mb-1"><strong>+224 XXX XXX XXX</strong></p>
                        <small class="text-muted">Lun-Ven : 8h-18h (GMT)</small>
                    </div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <div class="contact-method p-3 bg-light rounded h-100">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-envelope fa-2x text-success me-3"></i>
                            <div>
                                <h6 class="mb-1">Email direct</h6>
                                <p class="mb-0 text-muted">Support email</p>
                            </div>
                        </div>
                        <p class="mb-1"><strong>support@csig.gn</strong></p>
                        <small class="text-muted">Réponse sous 24h</small>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="contact-method p-3 bg-light rounded h-100">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-comments fa-2x text-info me-3"></i>
                            <div>
                                <h6 class="mb-1">Chat en ligne</h6>
                                <p class="mb-0 text-muted">Support en temps réel</p>
                            </div>
                        </div>
                        <p class="mb-1"><strong>Disponible 24h/24</strong></p>
                        <small class="text-muted">Via la plateforme</small>
                    </div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <div class="contact-method p-3 bg-light rounded h-100">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-map-marker-alt fa-2x text-warning me-3"></i>
                            <div>
                                <h6 class="mb-1">Bureau</h6>
                                <p class="mb-0 text-muted">Support en personne</p>
                            </div>
                        </div>
                        <p class="mb-1"><strong>Conakry, Guinée</strong></p>
                        <small class="text-muted">Sur rendez-vous</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- FAQ rapide -->
        <hr class="my-4">
        
        <div class="quick-faq">
            <h5 class="mb-3">
                <i class="fas fa-question-circle me-2"></i>Questions fréquentes
            </h5>
            
            <div class="accordion" id="faqAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="faq1">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse1">
                            <i class="fas fa-lock me-2"></i>J'ai oublié mon mot de passe
                        </button>
                    </h2>
                    <div id="collapse1" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Utilisez la fonction "Mot de passe oublié" sur la page de connexion. 
                            Un lien de réinitialisation vous sera envoyé par email.
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item">
                    <h2 class="accordion-header" id="faq2">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse2">
                            <i class="fas fa-user-plus me-2"></i>Comment créer un compte ?
                        </button>
                    </h2>
                    <div id="collapse2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Cliquez sur "Créer un compte" sur la page de connexion et suivez 
                            les instructions. Vous recevrez un email de confirmation.
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item">
                    <h2 class="accordion-header" id="faq3">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse3">
                            <i class="fas fa-cog me-2"></i>Problème d'accès à la plateforme
                        </button>
                    </h2>
                    <div id="collapse3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Vérifiez que vous utilisez un navigateur récent et que JavaScript est activé. 
                            Si le problème persiste, contactez-nous.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="auth-card-footer text-center">
        <p class="mb-0">
            <a href="{% url 'oauth:login' %}" class="auth-link">
                <i class="fas fa-arrow-left me-1"></i>Retour à la connexion
            </a>
            <span class="mx-2">•</span>
            <a href="{% url 'oauth:terms' %}" class="auth-link">
                <i class="fas fa-gavel me-1"></i>Conditions d'utilisation
            </a>
        </p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Validation en temps réel
    $('input[required], textarea[required], select[required]').on('blur', function() {
        validateField(this);
    });
    
    $('input[required], textarea[required], select[required]').on('input', function() {
        clearFieldValidation(this);
    });
    
    // Gestion de la soumission
    $('.auth-form').on('submit', function(e) {
        const submitBtn = $(this).find('button[type="submit"]');
        const spinner = submitBtn.find('.spinner-border');
        const btnText = submitBtn.find('span:not(.spinner-border)');
        
        // Afficher l'état de chargement
        submitBtn.prop('disabled', true);
        spinner.removeClass('d-none');
        btnText.addClass('d-none');
        
        // Re-enable après 10 secondes
        setTimeout(function() {
            submitBtn.prop('disabled', false);
            spinner.addClass('d-none');
            btnText.removeClass('d-none');
        }, 10000);
    });
    
    // Auto-focus sur le premier champ
    $('#name').focus();
    
    // Validation du sujet
    $('#subject').on('change', function() {
        if (this.value === 'other') {
            // Créer un champ de saisie libre pour le sujet
            if (!$('#custom_subject').length) {
                const customSubject = $(`
                    <div class="mt-2">
                        <input type="text" name="custom_subject" id="custom_subject" 
                               class="form-control" placeholder="Précisez votre sujet" required>
                    </div>
                `);
                $(this).parent().after(customSubject);
            }
        } else {
            $('#custom_subject').remove();
        }
    });
    
    // Compteur de caractères pour le message
    $('#message').on('input', function() {
        const maxLength = 1000;
        const currentLength = this.value.length;
        const remaining = maxLength - currentLength;
        
        // Créer ou mettre à jour le compteur
        let counter = $(this).parent().find('.char-counter');
        if (!counter.length) {
            counter = $('<small class="char-counter text-muted mt-1"></small>');
            $(this).parent().append(counter);
        }
        
        counter.text(`${currentLength}/${maxLength} caractères`);
        
        if (remaining < 0) {
            counter.addClass('text-danger');
        } else {
            counter.removeClass('text-danger');
        }
    });
});

// Validation des champs
function validateField(field) {
    const value = field.value.trim();
    let isValid = true;
    let errorMessage = '';
    
    if (field.hasAttribute('required') && !value) {
        isValid = false;
        errorMessage = 'Ce champ est requis';
    }
    
    if (isValid && value) {
        if (field.type === 'email' && !isValidEmail(value)) {
            isValid = false;
            errorMessage = 'Format d\'email invalide';
        }
        
        if (field.name === 'message' && value.length < 10) {
            isValid = false;
            errorMessage = 'Le message doit contenir au moins 10 caractères';
        }
    }
    
    if (isValid) {
        markFieldAsValid(field);
    } else {
        markFieldAsInvalid(field, errorMessage);
    }
    
    return isValid;
}

// Marquer un champ comme valide
function markFieldAsValid(field) {
    field.classList.remove('is-invalid');
    field.classList.add('is-valid');
    
    // Supprimer les messages d'erreur
    const errorDiv = field.parentNode.querySelector('.invalid-feedback');
    if (errorDiv) {
        errorDiv.remove();
    }
}

// Marquer un champ comme invalide
function markFieldAsInvalid(field, message) {
    field.classList.remove('is-valid');
    field.classList.add('is-invalid');
    
    // Supprimer l'ancien message d'erreur
    const existingError = field.parentNode.querySelector('.invalid-feedback');
    if (existingError) {
        existingError.remove();
    }
    
    // Ajouter le nouveau message d'erreur
    const errorDiv = document.createElement('div');
    errorDiv.className = 'invalid-feedback';
    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle me-1"></i>${message}`;
    
    // Insérer après le groupe d'input
    const inputGroup = field.closest('.input-group') || field.parentNode;
    inputGroup.parentNode.insertBefore(errorDiv, inputGroup.nextSibling);
}

// Effacer la validation d'un champ
function clearFieldValidation(field) {
    field.classList.remove('is-valid', 'is-invalid');
    
    // Supprimer les messages de validation
    const errorDiv = field.parentNode.querySelector('.invalid-feedback');
    if (errorDiv) {
        errorDiv.remove();
    }
    
    const validDiv = field.parentNode.querySelector('.valid-feedback');
    if (validDiv) {
        validDiv.remove();
    }
}

// Validation email
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}
</script>
{% endblock %}

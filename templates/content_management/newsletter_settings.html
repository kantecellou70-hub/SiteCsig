{% extends 'content_management/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}Paramètres des newsletters - CSIG{% endblock %}

{% block extra_css %}
<style>
.settings-container {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    overflow: hidden;
    max-width: 1000px;
    margin: 0 auto;
}

.settings-header {
    background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);
    color: white;
    padding: 2rem;
    text-align: center;
}

.settings-header h1 {
    margin: 0;
    font-size: 2rem;
    font-weight: 600;
}

.settings-header p {
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
}

.settings-body {
    padding: 2rem;
}

.settings-section {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border-left: 4px solid #ffc107;
}

.settings-section h3 {
    color: #495057;
    margin-bottom: 1.5rem;
    font-size: 1.25rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.settings-section h3 i {
    color: #ffc107;
    font-size: 1.1rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-label i {
    color: #ffc107;
    width: 20px;
}

.form-control, .form-select {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    padding: 0.75rem;
    transition: all 0.3s ease;
    font-size: 1rem;
}

.form-control:focus, .form-select:focus {
    border-color: #ffc107;
    box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
    outline: none;
}

.form-text {
    color: #6c757d;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.settings-actions {
    background: #f8f9fa;
    padding: 1.5rem 2rem;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.btn-primary {
    background: #ffc107;
    border-color: #ffc107;
    color: #212529;
}

.btn-primary:hover {
    background: #e0a800;
    border-color: #d39e00;
    color: #212529;
}

.btn-success {
    background: #28a745;
    border-color: #28a745;
}

.btn-info {
    background: #17a2b8;
    border-color: #17a2b8;
}

.btn-warning {
    background: #ffc107;
    border-color: #ffc107;
    color: #212529;
}

.btn-danger {
    background: #dc3545;
    border-color: #dc3545;
}

.status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
}

.status-connected {
    background: #d4edda;
    color: #155724;
}

.status-disconnected {
    background: #f8d7da;
    color: #721c24;
}

.status-testing {
    background: #fff3cd;
    color: #856404;
}

/* Modal styling for notifications */
.modal-header.success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
}

.modal-header.error {
    background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
    color: white;
}

.modal-header.warning {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    color: #212529;
}

.modal-header.info {
    background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
    color: white;
}

.test-result {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 8px;
    font-weight: 600;
}

.test-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.test-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.template-preview {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 0.5rem;
}

.template-preview h6 {
    color: #495057;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.template-preview p {
    color: #6c757d;
    margin: 0;
    font-size: 0.875rem;
}

@media (max-width: 768px) {
    .settings-container {
        margin: 0;
        border-radius: 0;
    }
    
    .settings-header {
        padding: 1.5rem;
    }
    
    .settings-header h1 {
        font-size: 1.5rem;
    }
    
    .settings-body {
        padding: 1rem;
    }
    
    .settings-section {
        padding: 1rem;
    }
    
    .settings-actions {
        flex-direction: column;
        align-items: stretch;
        padding: 1rem;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block page_title %}
<i class="fas fa-cog me-2"></i>Paramètres des newsletters
{% endblock %}

{% block page_subtitle %}
<p class="text-muted mb-0">Configurez les paramètres d'envoi et les templates</p>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <a href="{% url 'content_management:newsletter_list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Retour aux newsletters
    </a>
    <button class="btn btn-primary" onclick="saveAllSettings()">
        <i class="fas fa-save me-2"></i>Sauvegarder tout
    </button>
</div>
{% endblock %}

{% block content %}
<div class="settings-container">
    <!-- En-tête -->
    <div class="settings-header">
        <h1>
            <i class="fas fa-cog me-3"></i>Paramètres des newsletters
        </h1>
        <p>Configurez votre système d'envoi de newsletters</p>
    </div>

    <!-- Corps des paramètres -->
    <div class="settings-body">
        <!-- Paramètres email -->
        <div class="settings-section">
            <h3>
                <i class="fas fa-envelope"></i>
                Configuration email
            </h3>
            
            <form method="post" id="emailSettingsForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_email_settings">
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emailHost" class="form-label">
                                <i class="fas fa-server"></i>Serveur SMTP
                            </label>
                            <input type="text" class="form-control" id="emailHost" name="email_host" 
                                   value="{{ email_settings.host }}" placeholder="smtp.gmail.com">
                            <div class="form-text">Adresse du serveur SMTP</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emailPort" class="form-label">
                                <i class="fas fa-plug"></i>Port SMTP
                            </label>
                            <input type="number" class="form-control" id="emailPort" name="email_port" 
                                   value="{{ email_settings.port }}" placeholder="587">
                            <div class="form-text">Port du serveur SMTP (587 pour TLS, 465 pour SSL)</div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emailUser" class="form-label">
                                <i class="fas fa-user"></i>Nom d'utilisateur
                            </label>
                            <input type="email" class="form-control" id="emailUser" name="email_user" 
                                   value="{{ email_settings.user }}" placeholder="votre@email.com">
                            <div class="form-text">Adresse email d'envoi</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emailPassword" class="form-label">
                                <i class="fas fa-lock"></i>Mot de passe
                            </label>
                            <input type="password" class="form-control" id="emailPassword" name="email_password" 
                                   placeholder="••••••••">
                            <div class="form-text">Mot de passe de l'application</div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="useTLS" name="use_tls" 
                                       {% if email_settings.use_tls %}checked{% endif %}>
                                <label class="form-check-label" for="useTLS">
                                    <i class="fas fa-shield-alt"></i>Utiliser TLS
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="useSSL" name="use_ssl" 
                                       {% if email_settings.use_ssl %}checked{% endif %}>
                                <label class="form-check-label" for="useSSL">
                                    <i class="fas fa-lock"></i>Utiliser SSL
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-2"></i>Mettre à jour les paramètres email
                    </button>
                    <button type="button" class="btn btn-info ms-2" onclick="testEmailConnection()">
                        <i class="fas fa-paper-plane me-2"></i>Tester la connexion
                    </button>
                </div>
            </form>
            
            <!-- Statut de la connexion -->
            <div class="mt-3">
                <span class="status-indicator status-connected">
                    <i class="fas fa-check-circle"></i>
                    Connexion email configurée
                </span>
            </div>
            
            <!-- Résultat du test -->
            <div id="testResult" class="test-result" style="display: none;"></div>
        </div>

        <!-- Paramètres de template -->
        <div class="settings-section">
            <h3>
                <i class="fas fa-file-alt"></i>
                Templates de newsletter
            </h3>
            
            <form method="post" id="templateSettingsForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_template_settings">
                
                <div class="form-group">
                    <label for="defaultTemplate" class="form-label">
                        <i class="fas fa-star"></i>Template par défaut
                    </label>
                    <select class="form-select" id="defaultTemplate" name="default_template">
                        {% for template in template_settings.available_templates %}
                        <option value="{{ template }}" {% if template == template_settings.default_template %}selected{% endif %}>
                            {{ template }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Template utilisé par défaut pour les nouvelles newsletters</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-list"></i>Templates disponibles
                    </label>
                    <div class="row">
                        {% for template in template_settings.available_templates %}
                        <div class="col-md-4 mb-3">
                            <div class="template-preview">
                                <h6>{{ template }}</h6>
                                <p>Template de newsletter {{ template|slice:":-5"|title }}</p>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="previewTemplate('{{ template }}')">
                                    <i class="fas fa-eye me-1"></i>Aperçu
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-2"></i>Mettre à jour les paramètres de template
                    </button>
                </div>
            </form>
        </div>

        <!-- Paramètres d'envoi -->
        <div class="settings-section">
            <h3>
                <i class="fas fa-paper-plane"></i>
                Paramètres d'envoi
            </h3>
            
            <form method="post" id="sendingSettingsForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_sending_settings">
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="batchSize" class="form-label">
                                <i class="fas fa-layer-group"></i>Taille des lots
                            </label>
                            <input type="number" class="form-control" id="batchSize" name="batch_size" 
                                   value="{{ sending_settings.batch_size }}" min="1" max="1000" required>
                            <div class="form-text">Nombre d'emails envoyés par lot</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="delayBetweenBatches" class="form-label">
                                <i class="fas fa-clock"></i>Délai entre lots (secondes)
                            </label>
                            <input type="number" class="form-control" id="delayBetweenBatches" name="delay_between_batches" 
                                   value="{{ sending_settings.delay_between_batches }}" min="1" max="60" required>
                            <div class="form-text">Délai d'attente entre l'envoi de chaque lot</div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="maxRetries" class="form-label">
                                <i class="fas fa-redo"></i>Nombre maximum de tentatives
                            </label>
                            <input type="number" class="form-control" id="maxRetries" name="max_retries" 
                                   value="{{ sending_settings.max_retries }}" min="1" max="10" required>
                            <div class="form-text">Nombre de tentatives en cas d'échec</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="retryDelay" class="form-label">
                                <i class="fas fa-hourglass-half"></i>Délai de retry (secondes)
                            </label>
                            <input type="number" class="form-control" id="retryDelay" name="retry_delay" 
                                   value="{{ sending_settings.retry_delay }}" min="60" max="3600" required>
                            <div class="form-text">Délai d'attente avant une nouvelle tentative</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-2"></i>Mettre à jour les paramètres d'envoi
                    </button>
                </div>
            </form>
        </div>

        <!-- Actions système -->
        <div class="settings-section">
            <h3>
                <i class="fas fa-tools"></i>
                Actions système
            </h3>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <button type="button" class="btn btn-warning w-100" onclick="clearEmailQueue()">
                            <i class="fas fa-trash me-2"></i>Vider la file d'attente
                        </button>
                        <div class="form-text">Supprime tous les emails en attente d'envoi</div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <button type="button" class="btn btn-info w-100" onclick="optimizeDatabase()">
                            <i class="fas fa-database me-2"></i>Optimiser la base de données
                        </button>
                        <div class="form-text">Nettoie et optimise les tables de newsletter</div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <button type="button" class="btn btn-danger w-100" onclick="resetAllSettings()">
                            <i class="fas fa-undo me-2"></i>Réinitialiser tous les paramètres
                        </button>
                        <div class="form-text">Remet tous les paramètres à leurs valeurs par défaut</div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <button type="button" class="btn btn-primary w-100" onclick="exportSettings()">
                            <i class="fas fa-download me-2"></i>Exporter la configuration
                        </button>
                        <div class="form-text>Télécharge un fichier JSON avec tous les paramètres</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="settings-actions">
        <div>
            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                <i class="fas fa-undo me-2"></i>Réinitialiser
            </button>
        </div>
        
        <div>
            <button type="button" class="btn btn-primary" onclick="saveAllSettings()">
                <i class="fas fa-save me-2"></i>Sauvegarder tout
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Test de la connexion email
function testEmailConnection() {
    const testResult = document.getElementById('testResult');
    testResult.style.display = 'block';
    testResult.className = 'test-result status-testing';
    testResult.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Test de connexion en cours...';
    
    // Récupérer les paramètres du formulaire
    const formData = new FormData();
    formData.append('action', 'test_email_connection');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('email_host', document.getElementById('emailHost').value);
    formData.append('email_port', document.getElementById('emailPort').value);
    formData.append('email_user', document.getElementById('emailUser').value);
    formData.append('email_password', document.getElementById('emailPassword').value);
    formData.append('use_tls', document.getElementById('useTLS').checked ? 'on' : '');
    formData.append('use_ssl', document.getElementById('useSSL').checked ? 'on' : '');
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            testResult.className = 'test-result test-success';
            testResult.innerHTML = '<i class="fas fa-check-circle me-2"></i>' + data.message;
        } else {
            testResult.className = 'test-result test-error';
            testResult.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' + data.message;
        }
    })
    .catch(error => {
        testResult.className = 'test-result test-error';
        testResult.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Erreur lors du test de connexion.';
        console.error('Error:', error);
    });
}

// Sauvegarder tous les paramètres
function saveAllSettings() {
    // Soumettre tous les formulaires
    const emailForm = document.getElementById('emailSettingsForm');
    const templateForm = document.getElementById('templateSettingsForm');
    
    // Créer un FormData combiné
    const formData = new FormData();
    formData.append('action', 'update_email_settings');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('email_host', document.getElementById('emailHost').value);
    formData.append('email_port', document.getElementById('emailPort').value);
    formData.append('email_user', document.getElementById('emailUser').value);
    formData.append('email_password', document.getElementById('emailPassword').value);
    formData.append('use_tls', document.getElementById('useTLS').checked ? 'on' : '');
    formData.append('use_ssl', document.getElementById('useSSL').checked ? 'on' : '');
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showCustomNotification(data.message, 'success');
        } else {
            showCustomNotification(data.message, 'error');
        }
    })
    .catch(error => {
        showCustomNotification('Erreur lors de la sauvegarde des paramètres email.', 'error');
        console.error('Error:', error);
    });
    
    // Sauvegarder les paramètres de template
    const templateFormData = new FormData();
    templateFormData.append('action', 'update_template_settings');
    templateFormData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    templateFormData.append('default_template', document.getElementById('defaultTemplate').value);
    
    fetch(window.location.href, {
        method: 'POST',
        body: templateFormData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showCustomNotification(data.message, 'success');
        } else {
            showCustomNotification(data.message, 'error');
        }
    })
    .catch(error => {
        showCustomNotification('Erreur lors de la sauvegarde des paramètres de template.', 'error');
        console.error('Error:', error);
    });
}

// Mettre à jour les paramètres d'envoi
function updateSendingSettings() {
    const formData = new FormData();
    formData.append('action', 'update_sending_settings');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('batch_size', document.getElementById('batchSize').value);
    formData.append('delay_between_batches', document.getElementById('delayBetweenBatches').value);
    formData.append('max_retries', document.getElementById('maxRetries').value);
    formData.append('retry_delay', document.getElementById('retryDelay').value);
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showCustomNotification(data.message, 'success');
        } else {
            showCustomNotification(data.message, 'error');
        }
    })
    .catch(error => {
        showCustomNotification('Erreur lors de la mise à jour des paramètres d\'envoi.', 'error');
        console.error('Error:', error);
    });
}

// Aperçu d'un template
function previewTemplate(templateName) {
    const formData = new FormData();
    formData.append('action', 'preview_template');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('template_name', templateName);
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Créer un modal pour afficher l'aperçu
            const previewModal = document.createElement('div');
            previewModal.className = 'modal fade';
            previewModal.id = 'templatePreviewModal';
            previewModal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-eye me-2"></i>Aperçu du template ${templateName}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${data.preview_html}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(previewModal);
            const modal = new bootstrap.Modal(previewModal);
            modal.show();
            
            // Nettoyer le modal après fermeture
            previewModal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(previewModal);
            });
        } else {
            showCustomNotification(data.message, 'error');
        }
    })
    .catch(error => {
        showCustomNotification('Erreur lors de la génération de l\'aperçu.', 'error');
        console.error('Error:', error);
    });
}

// Vider la file d'attente
function clearEmailQueue() {
    showCustomConfirm('Êtes-vous sûr de vouloir vider la file d\'attente ? Cette action est irréversible.', function() {
        const formData = new FormData();
        formData.append('action', 'clear_email_queue');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(window.location.href, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showCustomNotification(data.message, 'success');
            } else {
                showCustomNotification(data.message, 'error');
            }
        })
        .catch(error => {
            showCustomNotification('Erreur lors du vidage de la file d\'attente.', 'error');
            console.error('Error:', error);
        });
    });
}

// Optimiser la base de données
function optimizeDatabase() {
    showCustomConfirm('Voulez-vous optimiser la base de données ? Cela peut prendre quelques minutes.', function() {
        const formData = new FormData();
        formData.append('action', 'optimize_database');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(window.location.href, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showCustomNotification(data.message, 'success');
            } else {
                showCustomNotification(data.message, 'error');
            }
        })
        .catch(error => {
            showCustomNotification('Erreur lors de l\'optimisation de la base de données.', 'error');
            console.error('Error:', error);
        });
    });
}

// Réinitialiser tous les paramètres
function resetAllSettings() {
    showCustomConfirm('Êtes-vous sûr de vouloir réinitialiser tous les paramètres ? Cette action est irréversible.', function() {
        const formData = new FormData();
        formData.append('action', 'reset_all_settings');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(window.location.href, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showCustomNotification(data.message, 'success');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showCustomNotification(data.message, 'error');
            }
        })
        .catch(error => {
            showCustomNotification('Erreur lors de la réinitialisation des paramètres.', 'error');
            console.error('Error:', error);
        });
    });
}

// Exporter la configuration
function exportSettings() {
    const formData = new FormData();
    formData.append('action', 'export_settings');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showCustomNotification(data.message, 'success');
        } else {
            showCustomNotification(data.message, 'error');
        }
    })
    .catch(error => {
        showCustomNotification('Erreur lors de l\'export de la configuration.', 'error');
        console.error('Error:', error);
    });
}

// Réinitialiser le formulaire
function resetForm() {
    showCustomConfirm('Voulez-vous réinitialiser tous les formulaires ?', function() {
        location.reload();
    });
}

// Validation des formulaires
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form');
    
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Empêcher la soumission par défaut
            
            // Validation basique
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                showCustomNotification('Veuillez remplir tous les champs obligatoires.', 'warning');
                return;
            }
            
            // Traiter la soumission selon l'action
            const action = form.querySelector('[name=action]').value;
            
            if (action === 'update_email_settings') {
                const formData = new FormData(form);
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showCustomNotification(data.message, 'success');
                    } else {
                        showCustomNotification(data.message, 'error');
                    }
                })
                .catch(error => {
                    showCustomNotification('Erreur lors de la sauvegarde.', 'error');
                    console.error('Error:', error);
                });
            } else if (action === 'update_template_settings') {
                const formData = new FormData(form);
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showCustomNotification(data.message, 'success');
                    } else {
                        showCustomNotification(data.message, 'error');
                    }
                })
                .catch(error => {
                    showCustomNotification('Erreur lors de la sauvegarde.', 'error');
                    console.error('Error:', error);
                });
            } else if (action === 'update_sending_settings') {
                const formData = new FormData(form);
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showCustomNotification(data.message, 'success');
                    } else {
                        showCustomNotification(data.message, 'error');
                    }
                })
                .catch(error => {
                    showCustomNotification('Erreur lors de la sauvegarde.', 'error');
                    console.error('Error:', error);
                });
            }
        });
    });
});
</script>
{% endblock %}

{% extends 'content_management/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}Gestion des abonnés - CSIG{% endblock %}

{% block extra_css %}
<style>
.subscribers-container {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    overflow: hidden;
}

.stats-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 2rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: #28a745;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #6c757d;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.management-actions {
    background: #f8f9fa;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.search-filters {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
}

.search-box {
    position: relative;
    min-width: 300px;
}

.search-box input {
    padding-left: 2.5rem;
    border-radius: 25px;
    border: 2px solid #e9ecef;
}

.search-box .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.filter-group label {
    font-weight: 600;
    color: #495057;
    margin: 0;
    white-space: nowrap;
}

.filter-group select {
    border-radius: 20px;
    border: 2px solid #e9ecef;
    padding: 0.5rem 1rem;
    min-width: 150px;
}

.bulk-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.subscribers-table {
    margin: 0;
    width: 100%;
}

.subscribers-table th {
    background: #f8f9fa;
    border: none;
    padding: 1rem;
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #e9ecef;
}

.subscribers-table td {
    padding: 1rem;
    border: none;
    border-bottom: 1px solid #e9ecef;
    vertical-align: middle;
}

.subscribers-table tbody tr:hover {
    background: #f8f9fa;
}

.subscriber-info {
    max-width: 300px;
}

.subscriber-email {
    font-weight: 600;
    color: #28a745;
    margin-bottom: 0.25rem;
}

.subscriber-name {
    color: #6c757d;
    font-size: 0.875rem;
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.status-inactive {
    background: #f8d7da;
    color: #721c24;
}

.subscriber-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.action-btn {
    padding: 0.5rem;
    border-radius: 6px;
    border: none;
    font-size: 0.875rem;
    transition: all 0.3s ease;
    min-width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.action-btn.edit {
    background: #e3f2fd;
    color: #1976d2;
}

.action-btn.toggle {
    background: #fff3cd;
    color: #856404;
}

.action-btn.delete {
    background: #ffebee;
    color: #d32f2f;
}

.language-badge {
    background: #e3f2fd;
    color: #1976d2;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
}

.pagination-container {
    background: #f8f9fa;
    padding: 1.5rem 2rem;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #6c757d;
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state h3 {
    color: #495057;
    margin-bottom: 1rem;
}

.empty-state p {
    margin-bottom: 2rem;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }
    
    .stat-number {
        font-size: 2rem;
    }
    
    .management-actions {
        flex-direction: column;
        align-items: stretch;
        padding: 1rem;
    }
    
    .search-filters {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }
    
    .search-box {
        min-width: auto;
    }
    
    .bulk-actions {
        justify-content: center;
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .subscribers-table {
        font-size: 0.875rem;
    }
    
    .subscribers-table th,
    .subscribers-table td {
        padding: 0.75rem 0.5rem;
    }
    
    .subscriber-info {
        max-width: 200px;
    }
    
    .subscriber-actions {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .action-btn {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block page_title %}
<i class="fas fa-users me-2"></i>Gestion des abonnés
{% endblock %}

{% block page_subtitle %}
<p class="text-muted mb-0">Gérez votre liste d'abonnés et leurs préférences</p>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <a href="{% url 'content_management:newsletter_create' %}" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>Nouvel abonné
    </a>
    <button class="btn btn-outline-secondary" onclick="exportSubscribers()">
        <i class="fas fa-download me-2"></i>Exporter
    </button>
</div>
{% endblock %}

{% block content %}
<div class="subscribers-container">
    <!-- En-tête avec statistiques -->
    <div class="stats-header">
        <h1>
            <i class="fas fa-users me-3"></i>Gestion des abonnés
        </h1>
        <p>Surveillez et gérez votre communauté d'abonnés</p>
    </div>
    
    <!-- Statistiques -->
    <div style="padding: 2rem;">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ total_subscribers }}</div>
                <div class="stat-label">Total abonnés</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ active_subscribers }}</div>
                <div class="stat-label">Abonnés actifs</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ inactive_subscribers }}</div>
                <div class="stat-label">Abonnés inactifs</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ language_stats|length }}</div>
                <div class="stat-label">Langues supportées</div>
            </div>
        </div>
        
        <!-- Répartition par langue -->
        {% if language_stats %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-globe me-2"></i>Répartition par langue
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for lang_stat in language_stats %}
                    <div class="col-md-3 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="language-badge">{{ lang_stat.language|upper }}</span>
                            <span class="badge bg-primary">{{ lang_stat.count }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Actions et filtres -->
    <div class="management-actions">
        <div class="search-filters">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="form-control" id="searchInput" placeholder="Rechercher des abonnés..." value="{{ search_query }}">
            </div>
            
            <div class="filter-group">
                <label for="statusFilter">Statut:</label>
                <select class="form-select" id="statusFilter">
                    <option value="">Tous les statuts</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Actifs</option>
                    <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactifs</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="languageFilter">Langue:</label>
                <select class="form-select" id="languageFilter">
                    <option value="">Toutes les langues</option>
                    <option value="fr" {% if language_filter == 'fr' %}selected{% endif %}>Français</option>
                    <option value="en" {% if language_filter == 'en' %}selected{% endif %}>English</option>
                </select>
            </div>
        </div>
        
        <div class="bulk-actions">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="selectAll">
                <label class="form-check-label" for="selectAll">
                    <strong>Sélectionner tout</strong>
                </label>
            </div>
            
            <select class="form-select" id="bulkAction">
                <option value="">Actions en lot</option>
                <option value="activate">Activer</option>
                <option value="deactivate">Désactiver</option>
                <option value="delete">Supprimer</option>
                <option value="export">Exporter sélection</option>
            </select>
            
            <button class="btn btn-primary" id="applyBulkAction" disabled>
                <i class="fas fa-play me-2"></i>Appliquer
            </button>
        </div>
    </div>

    <!-- Tableau des abonnés -->
    <div class="table-responsive">
        <table class="table subscribers-table" id="subscribersTable">
            <thead>
                <tr>
                    <th class="checkbox-cell">
                        <input type="checkbox" class="checkbox-custom" id="headerCheckbox">
                    </th>
                    <th>Abonné</th>
                    <th>Langue</th>
                    <th>Statut</th>
                    <th>Date d'inscription</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for subscriber in subscribers %}
                <tr data-subscriber-id="{{ subscriber.id }}" data-status="{% if subscriber.is_active %}active{% else %}inactive{% endif %}">
                    <td class="checkbox-cell">
                        <input type="checkbox" class="checkbox-custom subscriber-checkbox" value="{{ subscriber.id }}">
                    </td>
                    
                    <td>
                        <div class="subscriber-info">
                            <div class="subscriber-email">{{ subscriber.email }}</div>
                            {% if subscriber.name %}
                                <div class="subscriber-name">{{ subscriber.name }}</div>
                            {% endif %}
                        </div>
                    </td>
                    
                    <td>
                        <span class="language-badge">{{ subscriber.language|upper }}</span>
                    </td>
                    
                    <td>
                        <span class="status-badge status-{% if subscriber.is_active %}active{% else %}inactive{% endif %}">
                            {% if subscriber.is_active %}Actif{% else %}Inactif{% endif %}
                        </span>
                    </td>
                    
                    <td>
                        <div class="text-muted">
                            <div>{{ subscriber.created_at|date:"d/m/Y" }}</div>
                            <div style="font-size: 0.8rem;">{{ subscriber.created_at|date:"H:i" }}</div>
                        </div>
                    </td>
                    
                    <td>
                        <div class="subscriber-actions">
                            <a href="{% url 'content_management:newsletter_edit' subscriber.pk %}" 
                               class="action-btn edit" title="Modifier">
                                <i class="fas fa-edit"></i>
                            </a>
                            
                            <button class="action-btn toggle" title="{% if subscriber.is_active %}Désactiver{% else %}Activer{% endif %}" 
                                    onclick="toggleSubscriberStatus({{ subscriber.pk }}, {% if subscriber.is_active %}false{% else %}true{% endif %})">
                                <i class="fas fa-{% if subscriber.is_active %}toggle-off{% else %}toggle-on{% endif %}"></i>
                            </button>
                            
                            <button class="action-btn delete" title="Supprimer" 
                                    onclick="deleteSubscriber({{ subscriber.pk }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>Aucun abonné trouvé</h3>
                            <p>Commencez par ajouter votre premier abonné à la newsletter.</p>
                            <a href="{% url 'content_management:newsletter_create' %}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Ajouter un abonné
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if subscribers.has_other_pages %}
    <div class="pagination-container">
        <div class="pagination-info">
            Affichage de {{ subscribers.start_index }} à {{ subscribers.end_index }} 
            sur {{ subscribers.paginator.count }} abonnés
        </div>
        
        <nav aria-label="Navigation des abonnés">
            <ul class="pagination">
                {% if subscribers.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1" title="Première page">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ subscribers.previous_page_number }}" title="Page précédente">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    </li>
                {% endif %}
                
                {% for num in subscribers.paginator.page_range %}
                    {% if subscribers.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > subscribers.number|add:'-3' and num < subscribers.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if subscribers.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ subscribers.next_page_number }}" title="Page suivante">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ subscribers.paginator.num_pages }}" title="Dernière page">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initSearchAndFilters();
    initBulkActions();
    initCheckboxes();
});

// Recherche et filtres
function initSearchAndFilters() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const languageFilter = document.getElementById('languageFilter');
    
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                applyFilters();
            }, 300);
        });
    }
    
    if (statusFilter) {
        statusFilter.addEventListener('change', applyFilters);
    }
    
    if (languageFilter) {
        languageFilter.addEventListener('change', applyFilters);
    }
}

function applyFilters() {
    const searchTerm = document.getElementById('searchInput')?.value || '';
    const status = document.getElementById('statusFilter')?.value || '';
    const language = document.getElementById('languageFilter')?.value || '';
    
    const params = new URLSearchParams();
    if (searchTerm) params.append('search', searchTerm);
    if (status) params.append('status', status);
    if (language) params.append('language', language);
    
    window.location.href = `{% url 'content_management:newsletter_subscribers_management' %}?${params.toString()}`;
}

// Actions en lot
function initBulkActions() {
    const bulkActionSelect = document.getElementById('bulkAction');
    const applyButton = document.getElementById('applyBulkAction');
    
    if (bulkActionSelect && applyButton) {
        bulkActionSelect.addEventListener('change', function() {
            applyButton.disabled = !this.value;
        });
        
        applyButton.addEventListener('click', function() {
            const action = bulkActionSelect.value;
            const selectedIds = getSelectedSubscriberIds();
            
            if (selectedIds.length === 0) {
                alert('Veuillez sélectionner au moins un abonné.');
                return;
            }
            
            if (confirm(`Êtes-vous sûr de vouloir ${getActionText(action)} ${selectedIds.length} abonné(s) ?`)) {
                executeBulkAction(action, selectedIds);
            }
        });
    }
}

function getActionText(action) {
    const actions = {
        'activate': 'activer',
        'deactivate': 'désactiver',
        'delete': 'supprimer définitivement',
        'export': 'exporter'
    };
    return actions[action] || action;
}

function executeBulkAction(action, subscriberIds) {
    if (action === 'export') {
        // Export des abonnés sélectionnés
        const params = new URLSearchParams();
        params.append('ids', subscriberIds.join(','));
        window.location.href = `{% url 'content_management:newsletter_export' %}?${params.toString()}`;
        return;
    }
    
    // Autres actions en lot
    const formData = new FormData();
    formData.append('action', action);
    formData.append('subscriber_ids', JSON.stringify(subscriberIds));
    
    // TODO: Implémenter les actions en lot
    alert(`Action "${action}" à implémenter pour ${subscriberIds.length} abonné(s)`);
}

// Gestion des cases à cocher
function initCheckboxes() {
    const headerCheckbox = document.getElementById('headerCheckbox');
    const subscriberCheckboxes = document.querySelectorAll('.subscriber-checkbox');
    const selectAllCheckbox = document.getElementById('selectAll');
    
    if (headerCheckbox) {
        headerCheckbox.addEventListener('change', function() {
            subscriberCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            if (selectAllCheckbox) selectAllCheckbox.checked = this.checked;
            updateBulkActionButton();
        });
    }
    
    subscriberCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateHeaderCheckbox();
            updateBulkActionButton();
        });
    });
    
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            subscriberCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            if (headerCheckbox) headerCheckbox.checked = this.checked;
            updateBulkActionButton();
        });
    }
}

function updateHeaderCheckbox() {
    const headerCheckbox = document.getElementById('headerCheckbox');
    const subscriberCheckboxes = document.querySelectorAll('.subscriber-checkbox');
    const checkedCount = document.querySelectorAll('.subscriber-checkbox:checked').length;
    
    if (headerCheckbox) {
        if (checkedCount === 0) {
            headerCheckbox.indeterminate = false;
            headerCheckbox.checked = false;
        } else if (checkedCount === subscriberCheckboxes.length) {
            headerCheckbox.indeterminate = false;
            headerCheckbox.checked = true;
        } else {
            headerCheckbox.indeterminate = true;
            headerCheckbox.checked = false;
        }
    }
}

function updateBulkActionButton() {
    const selectedIds = getSelectedSubscriberIds();
    const applyButton = document.getElementById('applyBulkAction');
    const bulkActionSelect = document.getElementById('bulkAction');
    
    if (applyButton && bulkActionSelect) {
        applyButton.disabled = selectedIds.length === 0 || !bulkActionSelect.value;
    }
}

function getSelectedSubscriberIds() {
    const checkboxes = document.querySelectorAll('.subscriber-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

// Actions individuelles
function toggleSubscriberStatus(subscriberId, newStatus) {
    const action = newStatus ? 'activer' : 'désactiver';
    if (confirm(`Êtes-vous sûr de vouloir ${action} cet abonné ?`)) {
        // TODO: Implémenter le changement de statut
        alert(`Changement de statut à implémenter pour l'abonné ${subscriberId}`);
    }
}

function deleteSubscriber(subscriberId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cet abonné ? Cette action est irréversible.')) {
        // TODO: Implémenter la suppression
        alert(`Suppression à implémenter pour l'abonné ${subscriberId}`);
    }
}

// Export des abonnés
function exportSubscribers() {
    const searchTerm = document.getElementById('searchInput')?.value || '';
    const status = document.getElementById('statusFilter')?.value || '';
    const language = document.getElementById('languageFilter')?.value || '';
    
    const params = new URLSearchParams();
    if (searchTerm) params.append('search', searchTerm);
    if (status) params.append('status', status);
    if (language) params.append('language', language);
    
    window.location.href = `{% url 'content_management:newsletter_export' %}?${params.toString()}`;
}
</script>
{% endblock %}
